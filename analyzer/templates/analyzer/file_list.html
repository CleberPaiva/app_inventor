{% extends 'analyzer/base.html' %}

{% block title %}Lista de Arquivos - Analisador de Apps .aia{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
    <div>
        <h1 class="md-headline-large">
            <span class="material-icons" style="margin-right: 16px; vertical-align: middle;">folder</span>
            Arquivos .aia
        </h1>
        <p class="md-body-large" style="color: var(--md-sys-color-on-surface-variant);">
            Gerencie seus projetos do MIT App Inventor
        </p>
    </div>
    <a href="{% url 'upload_file' %}" class="md-button md-button-filled">
        <span class="material-icons" style="margin-right: 8px;">cloud_upload</span>
        Novo Upload
    </a>
</div>

{% if files %}
    <div class="grid grid-cols-3" style="gap: 24px;">
        {% for file in files %}
            <div class="md-card md-card-elevated" style="height: fit-content;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                    <h3 class="md-title-medium">{{ file.name|truncatechars:25 }}</h3>
                    {% if file.is_analyzed %}
                        <div class="md-chip quality-excellent">
                            <span class="material-icons" style="font-size: 16px; margin-right: 4px;">check</span>
                            Analisado
                        </div>
                    {% else %}
                        <div class="md-chip quality-medium">
                            <span class="material-icons" style="font-size: 16px; margin-right: 4px;">hourglass_empty</span>
                            Pendente
                        </div>
                    {% endif %}
                </div>
                
                <div style="margin-bottom: 16px;">
                    <p class="md-body-medium" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: 8px;">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">schedule</span>
                        {{ file.uploaded_at|date:"d/m/Y H:i" }}
                    </p>
                    <p class="md-body-medium" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: 8px;">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">storage</span>
                        {{ file.file_size_mb }} MB
                    </p>
                    {% if file.uploaded_by %}
                        <p class="md-body-medium" style="color: var(--md-sys-color-on-surface-variant);">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">person</span>
                            {{ file.uploaded_by.username }}
                        </p>
                    {% endif %}
                </div>
                
                {% if file.is_analyzed %}
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; text-align: center;">
                        <div>
                            <div style="font-size: 24px; font-weight: 500; color: var(--md-sys-color-primary);">
                                {{ file.total_images }}
                            </div>
                            <div class="md-body-medium" style="color: var(--md-sys-color-on-surface-variant);">
                                Imagens
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: 500; color: var(--md-sys-color-secondary);">
                                {{ file.total_icons }}
                            </div>
                            <div class="md-body-medium" style="color: var(--md-sys-color-on-surface-variant);">
                                Ícones
                            </div>
                        </div>
                    </div>
                    
                    {% if file.evaluation %}
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span class="md-body-medium" style="color: var(--md-sys-color-on-surface-variant);">Score Geral</span>
                                <span style="font-weight: 500; color: var(--md-sys-color-primary);">
                                    {{ file.evaluation.overall_usability_score|floatformat:0 }}%
                                </span>
                            </div>
                            <div class="progress-linear">
                                <div class="progress-bar" style="width: {{ file.evaluation.overall_usability_score }}%;"></div>
                            </div>
                        </div>
                        
                        {% if file.evaluation.total_issues > 0 %}
                            <div class="alert alert-warning" style="padding: 12px; margin-bottom: 16px;">
                                <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">warning</span>
                                {{ file.evaluation.total_issues }} problema(s) detectado(s)
                            </div>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <div style="text-align: center; margin-bottom: 16px; padding: 24px;">
                        <span class="material-icons" style="font-size: 48px; color: var(--md-sys-color-on-surface-variant); opacity: 0.6;">
                            hourglass_empty
                        </span>
                        <p class="md-body-medium" style="color: var(--md-sys-color-on-surface-variant); margin-top: 8px;">
                            Aguardando análise
                        </p>
                    </div>
                {% endif %}
                
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <a href="{% url 'file_detail' file.pk %}" class="md-button md-button-filled" style="text-align: center;">
                        <span class="material-icons" style="margin-right: 8px;">visibility</span>
                        Ver Detalhes
                    </a>
                    {% if file.is_analyzed %}
                        <a href="{% url 'analysis_results' file.pk %}" class="md-button md-button-outlined" style="text-align: center;">
                            <span class="material-icons" style="margin-right: 8px;">analytics</span>
                            Resultados
                        </a>
                        <a href="{% url 'print_analysis' file.pk %}" class="md-button md-button-text" style="text-align: center; border: 1px solid var(--md-sys-color-outline);" target="_blank">
                            <span class="material-icons" style="margin-right: 8px;">print</span>
                            Imprimir Relatório
                        </a>
                        <form method="post" action="{% url 'analyze_file' file.pk %}" style="margin: 0;">
                            {% csrf_token %}
                            <button type="submit" class="md-button md-button-text" style="width: 100%; border: 1px solid var(--md-sys-color-outline);">
                                <span class="material-icons" style="margin-right: 8px;">refresh</span>
                                Reanalizar
                            </button>
                        </form>
                    {% else %}
                        <form method="post" action="{% url 'analyze_file' file.pk %}">
                            {% csrf_token %}
                            <button type="submit" class="md-button md-button-outlined" style="width: 100%;">
                                <span class="material-icons" style="margin-right: 8px;">play_circle</span>
                                Analisar
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
    
    <!-- Pagination if needed -->
    {% if is_paginated %}
        <div style="display: flex; justify-content: center; margin-top: 32px;">
            <div style="display: flex; gap: 8px; align-items: center;">
                {% if page_obj.has_previous %}
                    <a href="?page=1" class="md-button md-button-text">Primeira</a>
                    <a href="?page={{ page_obj.previous_page_number }}" class="md-button md-button-text">
                        <span class="material-icons">chevron_left</span>
                    </a>
                {% endif %}
                
                <span class="md-body-medium" style="padding: 10px 16px; color: var(--md-sys-color-on-surface-variant);">
                    Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                </span>
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="md-button md-button-text">
                        <span class="material-icons">chevron_right</span>
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}" class="md-button md-button-text">Última</a>
                {% endif %}
            </div>
        </div>
    {% endif %}

{% else %}
    <!-- Empty state -->
    <div class="md-card" style="text-align: center; padding: 64px 24px; max-width: 600px; margin: 0 auto;">
        <span class="material-icons" style="font-size: 96px; color: var(--md-sys-color-on-surface-variant); opacity: 0.6; margin-bottom: 24px;">
            folder_open
        </span>
        <h2 class="md-headline-medium" style="margin-bottom: 16px;">Nenhum arquivo enviado</h2>
        <p class="md-body-large" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: 32px;">
            Comece enviando seu primeiro arquivo .aia do MIT App Inventor 
            para análise de usabilidade.
        </p>
        <a href="{% url 'upload_file' %}" class="md-button md-button-filled" style="font-size: 16px; padding: 16px 32px;">
            <span class="material-icons" style="margin-right: 8px;">cloud_upload</span>
            Enviar Primeiro Arquivo
        </a>
    </div>
{% endif %}
{% endblock %}
